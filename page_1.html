<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전공학과 월드컵</title>
  <!-- ✅ 모바일 뷰포트 추가 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 머티리얼 아이콘 (선택사항: 홈 아이콘 등) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* 터치 하이라이트 제거 & 박스사이징 통일(모바일 레이아웃 안정화) */
    * { box-sizing: border-box; }
    html, body { -webkit-tap-highlight-color: transparent; }

    body { font-size: 24px; font-family: sans-serif; text-align: center; margin: 0; background: #f9f9f9; }
    button, .btn { cursor: pointer; transition: transform .08s ease, box-shadow .15s; }
    button:active, .btn:active { transform: translateY(1px); }
    .material-icons { font-size: 24px; vertical-align: middle; }

    .input-container, .instruction, .category-select, .tournament, .result-area, .round-loading, .details-area { display: none; margin-top: 50px; }
    .instruction { max-width: 900px; margin: 50px auto 24px; text-align: left; line-height: 1.5em; padding: 0 24px }

    /* ✅ 100vh 이슈 보완: 주소창 높이 변화 대응 */
    .input-container {
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
      height: 100vh;           /* 기존 값 유지(구형 브라우저) */
      min-height: 100dvh;      /* ✅ 모바일 실제 화면 높이 */
    }
    .input-container input, .input-container button { width: 300px; height: 48px; font-size: 18px; padding: 10px 16px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; }

    .category-select { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    .bold-major { font-weight: bold; font-size: 48px; color: black; }
    .friend-text { font-size: 24px; color: #007ACC; margin-top: 30px; word-break: keep-all; overflow-wrap: break-word; white-space: normal; line-height: 1.5em; }

    .card { display: inline-block; width: 40%; margin: 20px; padding: 30px; border: 2px solid #aaa; border-radius: 10px; background: white; cursor: pointer; vertical-align: top; }
    .card-pair { display: flex; justify-content: center; align-items: stretch; gap: 40px; margin-bottom: 0; }

    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #555; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    table { margin: auto 60px; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ccc; padding: 10px 10px; min-width: 120px; }

    #resultArea table.summary-table th:nth-child(2),
    #resultArea table.summary-table td:nth-child(2) { min-width: 200px; }

    #resultArea table.summary-table tr:not(:first-child) td:nth-child(3) { text-align: left; }

    #resultArea .results-note { font-size: 24px; color: #6b7280; margin: 12px 60px 18px; text-align: left; line-height: 1.5; }

    button { font-size: 24px; margin: 10px; padding: 10px 20px; }
    .circle-list { list-style: none; counter-reset: section; padding-left: 0; }
    .circle-list li { counter-increment: section; position: relative; padding-left: 1.5em; text-indent: 0; }
    .circle-list li::before { content: counter(section, upper-roman) "."; position: absolute; left: 0; width: 1.5em; display: inline-block; }
    .highlight-doc { color: #007ACC; font-weight: bold;}
    h1 { font-size: 28px; margin: 18px 0 18px; font-weight: bold; }

    .major-label { display: inline-flex; align-items: center; gap: 8px; }
    .major-label input[type="checkbox"] { transform: scale(1.1); }

    .details-area { display: none; max-width: 1200px; margin: 40px auto; text-align: left; }
    .detail-item { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin: 18px 24px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .info-list { list-style: none; padding: 0; margin: 0; }
    .info-list li { margin: 8px 0; }
    .k { font-weight: 700; margin-right: 8px; }
    .v { white-space: pre-wrap; word-break: keep-all; line-height: 1.6; }
    .v-major { font-size: 1.05em; font-weight: 800; }
    .desc { margin-top: 6px; }
    .section-heading { display: flex; align-items: center; gap: 8px; margin: 14px 0 6px; font-weight: 800; }
    .section-heading .icon { font-size: 1.15em; }
    #detailsArea .toolbar { margin: 16px 24px; }

    /* ✅ 모바일 전용 (가로폭 768px 이하) */
    @media (max-width: 768px) {
      .instruction { padding: 0 16px; }
      ul.circle-list { font-size: 18px; line-height: 1.6em; }

      /* 버튼/카테고리 조작성 개선 */
      .category-select { flex-direction: column; align-items: stretch; gap: 12px; }
      .category-select button { width: 100%; }

      .card-pair { flex-direction: column; gap: 20px; align-items: center; }
      .card { width: 90%; max-width: 540px; margin: 10px 0; padding: 20px; font-size: 18px; }
      .bold-major { font-size: 24px; }
      .friend-text { font-size: 16px; margin-top: 20px; }

      #resultArea table { margin: 12px; width: calc(100% - 24px); table-layout: fixed; }
      #resultArea table.summary-table th,
      #resultArea table.summary-table td { padding: 8px 8px; font-size: 12px; word-break: break-word; }
      #resultArea table.summary-table th:nth-child(1),
      #resultArea table.summary-table td:nth-child(1) { width: 16%; }
      #resultArea table.summary-table th:nth-child(2),
      #resultArea table.summary-table td:nth-child(2) { width: 24%; min-width: 140px; }
      #resultArea table.summary-table tr:not(:first-child) td:nth-child(3) { text-align: left; white-space: normal; }
      #resultArea .results-note { font-size: 16px; margin: 8px 12px 12px; line-height: 1.6; }
      #resultArea { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }

    /* ✅ 초소형(≤360px) 보완 */
    @media (max-width: 360px) {
      body { font-size: 20px; }
      h1 { font-size: 22px; }
      button { font-size: 18px; padding: 10px 14px; }
      .card { width: 96%; }
    }
  </style>
</head>
<body>
  <h1>전공학과 이상형 월드컵</h1>
  <div class="input-container" id="inputForm">
    <input id="school" placeholder="학교명" />
    <div style="height:10px"></div>
    <input id="student_id" placeholder="학번" />
    <div style="height:10px"></div>
    <input id="student_name" placeholder="이름" />
    <div style="height:10px"></div>
    <button onclick="showInstruction()">다음</button>
    <div style="height:10px"></div>
    <button onclick="goToIndex()"><span class="material-icons">home</span>메인으로</button>
  </div>

  <div class="instruction" id="instruction" style="max-width: 900px; margin: auto; text-align: left; line-height: 1.5em;">
    <ul class="circle-list">
      <li><b>「전공학과 월드컵」</b> 프로그램은 대학 전공에 대한 관심 수준을 알아보기 위해 제작되었습니다.</li>
      <li>선택한 계열에서 2개의 학과가 짝(pair)을 이루어 보여지며, 더 관심있는 학과를 선택하는 토너먼트 방식으로 진행합니다.</li>
      <li><b>[인문+공통+체육], [자연+공통] 중 하나</b>를 선택하여 64강부터 진행합니다.</li>
      <li><b>공통 8, 인문 43, 자연 56, 체육 5</b> 개의 전공 학과 대상이며, [인문+공통+체육]은 임의로 선정된 8개 학과가 부전승으로 32강에 합류합니다.</li>
      <li>라운드가 종료되면, 8강까지 진출한 전공 학과의 리스트를 확인할 수 있습니다.</li>
    </ul>
    <div class="category-select">
      <button onclick="startCategory('inmun')">인문+공통+체육</button>
      <button onclick="startCategory('jayeon')">자연+공통</button>
    </div>
  </div>

  <div class="round-loading" id="roundLoading">
    <div class="spinner"></div>
    <p id="roundText"></p>
  </div>

  <div class="tournament" id="tournament"></div>

  <div class="result-area" id="resultArea"></div>

  <!-- 새 “페이지” 역할의 상세 보기 섹션 -->
  <div class="details-area" id="detailsArea"></div>

  <!-- CSV 파서 & 앱 유틸 (CSV_URLS, fetchSheetRows 등) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="./assets/app.js"></script>

  <script>
    let roundData = [];     // 현재 라운드 항목 배열
    let roundResults = [];  // 라운드별 요약
    let roundHistory = [];  // 최근 라운드 기록(결승/4강/8강 추출용)
    let userInfo = {};

    // 상세 페이지용 전체 인덱스 — major → item
    let dataIndex = new Map();

    // 부전승/바이 관리
    let autoPassList = [];      // inmun: 7개
    let hasAutoPass = false;    // inmun 첫 라운드 종료 직후 1회 사용
    let firstRoundBye = null;   // inmun 첫 라운드용 추가 자동진출 1개

    // 안전 출력 유틸
    function escapeHTML(str) {
      const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
      return String(str).replace(/[&<>"']/g, m => map[m]);
    }
    function escapeAttr(str) {
      return escapeHTML(str).replace(/`/g, '&#96;');
    }

    // 진입 화면 표시
    document.getElementById('inputForm').style.display = 'block';

    // Enter로 진행
    ['school','student_id','student_name'].forEach(id=>{
      document.getElementById(id).addEventListener('keydown', e=>{
        if(e.key==='Enter') showInstruction();
      });
    });

    // 메인으로 (GAS 호출 → 정적 페이지 이동)
    function goToIndex() { location.href = './index.html'; }

    function showInstruction() {
      userInfo.school = document.getElementById('school').value || '';
      userInfo.id     = document.getElementById('student_id').value || '';
      userInfo.name   = document.getElementById('student_name').value || '';
      document.getElementById('inputForm').style.display = 'none';
      document.getElementById('instruction').style.display = 'block';
    }

    function shuffleArray(arr) { return [...arr].sort(() => Math.random() - 0.5); }

    function buildTournament(items) {
      if (items.length % 2 === 1) items = items.slice(0, items.length - 1);
      return shuffleArray(items);
    }

    function getRoundLabel(itemCount) {
      if (itemCount === 1) return '최종 선택 결과';
      if (itemCount === 2) return '결승';
      if (itemCount === 4) return '4강';
      if (itemCount === 8) return '8강';
      if (itemCount === 16) return '16강';
      if (itemCount === 32) return '32강';
      if (itemCount === 64) return '64강';
      return `${itemCount}강`;
    }

    function showLoading(name) {
      document.getElementById('roundText').innerText = `${name} 로딩중...`;
      document.getElementById('roundLoading').style.display = 'block';
    }
    function hideLoading() {
      document.getElementById('roundLoading').style.display = 'none';
    }

    /** 카테고리 시작: CSV에서 데이터 로드 (알고리즘은 그대로) */
    function startCategory(sheetName) {
      document.getElementById('instruction').style.display = 'none';
      document.getElementById('resultArea').style.display = 'none';
      document.getElementById('detailsArea').style.display = 'none';
      showLoading('데이터');

      // 🔁 GAS → CSV 로더로 교체 (assets/app.js의 fetchSheetRows 사용)
      fetchSheetRows(sheetName).then((data) => {
        if (!Array.isArray(data) || data.length === 0) {
          alert('데이터가 없습니다.');
          hideLoading();
          return;
        }
        data = shuffleArray(data);

        if (sheetName === 'inmun') {
          // 56개 사용: 부전승 7, 나머지 49 중 1개는 ‘바이’, 48개로 64강 진행
          const selected = data.slice(0, 56);
          autoPassList   = selected.slice(0, 7);
          const remain49 = selected.slice(7, 56);
          const shuffledRemain = shuffleArray(remain49);
          firstRoundBye  = shuffledRemain[0];
          const others48 = shuffledRemain.slice(1);
          roundData      = buildTournament(others48);
          hasAutoPass    = true;

          // 상세용 인덱스(선택된 56개 전체)
          dataIndex = new Map(selected.map(it => [it.major, it]));
        } else {
          // jayeon: 64개 바로
          const used = data.slice(0, 64);
          roundData   = buildTournament(used);
          hasAutoPass = false;
          autoPassList = [];
          firstRoundBye = null;

          dataIndex = new Map(used.map(it => [it.major, it]));
        }

        hideLoading();
        document.getElementById('tournament').style.display = 'block';
        playRound(roundData);
      }).catch((err) => {
        console.error(err);
        alert('데이터 불러오기 실패: ' + (err && err.message ? err.message : err));
        hideLoading();
      });
    }

    // 카드 높이 동기화
    function equalizeHeights(a, b){
      if (window.innerWidth <= 768) { a.style.height = ''; b.style.height = ''; return; }
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        const maxH = Math.max(a.offsetHeight, b.offsetHeight);
        a.style.height = b.style.height = `${maxH}px`;
      }));
    }

    function playRound(items) {
      const container = document.getElementById('tournament');
      container.innerHTML = '';

      if (items.length === 1) {
        saveRoundResult(items[0]);
        showSummary();
        return;
      }

      roundData = items;
      roundHistory.push([...items]);

      const nextRound = [];
      let index = 0;

      showLoading(getRoundLabel(items.length));
      setTimeout(() => { hideLoading(); nextPair(); }, 300);

      function nextPair() {
        container.innerHTML = '';

        if (index >= items.length) {
          let nextItems = nextRound;

          // inmun: 24 승자 + 바이1 + 부전승7 = 32
          if (items.length === 48 && hasAutoPass) {
            if (firstRoundBye) nextItems = [...nextItems, firstRoundBye];
            if (autoPassList && autoPassList.length === 7) nextItems = [...nextItems, ...autoPassList];
            firstRoundBye = null; autoPassList = []; hasAutoPass = false;
            nextItems = shuffleArray(nextItems);
          }

          const nextLabel = getRoundLabel(nextItems.length);
          showLoading(nextLabel);
          setTimeout(() => { hideLoading(); playRound(nextItems); }, 600);
          return;
        }

        if (index === items.length - 1) {
          nextRound.push(items[index]);
          index += 1;
          nextPair();
          return;
        }

        const a = items[index];
        const b = items[index + 1];
        const cardA = createCard(a);
        const cardB = createCard(b);

        const wrapper = document.createElement('div');
        wrapper.className = 'card-pair';
        wrapper.appendChild(cardA);
        wrapper.appendChild(cardB);
        container.appendChild(wrapper);

        equalizeHeights(cardA, cardB);

        cardA.onclick = () => { nextRound.push(a); index += 2; nextPair(); };
        cardB.onclick = () => { nextRound.push(b); index += 2; nextPair(); };
      }
    }

    function createCard(item) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class='bold-major'>${escapeHTML(item.major)}</div>
        <div class='friend-text'>${escapeHTML(item.friends || '')}</div>
      `;
      return div;
    }

    function saveRoundResult(winner) {
      const last1 = roundHistory[roundHistory.length - 1] || [];
      const last2 = roundHistory[roundHistory.length - 2] || [];
      const last3 = roundHistory[roundHistory.length - 3] || [];
      const finals   = last1.slice(0, 2);
      const semis    = last2.slice(0, 4);
      const quarters = last3.slice(0, 8);
      roundResults.push({ final: winner, finals, semis, quarters });
    }

    function showSummary() {
      document.getElementById('tournament').style.display = 'none';
      const result = document.getElementById('resultArea');
      result.style.display = 'block';

      let html = `<p><span class="highlight-doc">${escapeHTML(userInfo.school)} ${escapeHTML(userInfo.id)} ${escapeHTML(userInfo.name)} 님의 전공 학과 월드컵 결과</span></p>`;

      roundResults.forEach((round) => {
        const finalsOthers = round.finals.filter(x => x.major !== round.final.major);
        const semisOnly    = round.semis.filter(x => !round.finals.includes(x));
        const quartersOnly = round.quarters.filter(x => !round.semis.includes(x));

        html += ` <span class="highlight-doc">토너먼트 8강까지 진출한 전공 학과 입니다.</span>
        <table class="summary-table">
          <tr><th>구분</th><th>전공</th><th>유사학과</th></tr>`;

        const majorCell = (item) => `
          <label class="major-label">
            <input type="checkbox" class="major-select" value="${escapeAttr(item.major)}">
            ${escapeHTML(item.major)}
          </label>`;

        html += `<tr><td>최종 선택</td><td>${majorCell(round.final)}</td><td>${escapeHTML(round.final.friends || '')}</td></tr>`;
        finalsOthers.forEach(item => {
          html += `<tr><td>결승 진출</td><td>${majorCell(item)}</td><td>${escapeHTML(item.friends || '')}</td></tr>`;
        });
        semisOnly.forEach(item => {
          html += `<tr><td>4강 진출</td><td>${majorCell(item)}</td><td>${escapeHTML(item.friends || '')}</td></tr>`;
        });
        quartersOnly.forEach(item => {
          html += `<tr><td>8강 진출</td><td>${majorCell(item)}</td><td>${escapeHTML(item.friends || '')}</td></tr>`;
        });

        html += `</table>`;
      });

      html += `
        <div class="results-note">
          ※ 관심 있는 전공 학과에 체크 박스 표시 후, 아래 <b>「전공 관련 선택과목 보기」</b> 버튼을 클릭해 주세요.
        </div>
        <div class="toolbar">
          <button id="showSubjectsBtn"> <span class="material-icons">menu_book</span> 전공 관련 선택과목 보기</button>
          <button id="printResultBtn"> <span class="material-icons">print</span> 인쇄하기</button>
          <button onclick="backToIndex()"> <span class="material-icons">sports_esports</span> 다시 하기</button>
        </div>`;
      result.innerHTML = html;

      document.getElementById('printResultBtn').onclick = () => window.print();
      document.getElementById('showSubjectsBtn').onclick = showSelectedSubjects;
    }

    function showSelectedSubjects() {
      const checked = Array.from(document.querySelectorAll('.major-select:checked')).map(cb => cb.value);
      const uniqueMajors = Array.from(new Set(checked));
      if (uniqueMajors.length === 0) { alert('전공을 하나 이상 선택해주세요.'); return; }
      const items = uniqueMajors.map(m => dataIndex.get(m)).filter(Boolean);
      renderDetails(items);
    }

    function renderDetails(items) {
      const area = document.getElementById('detailsArea');
      document.getElementById('resultArea').style.display = 'none';
      area.style.display = 'block';

      let html = `<h3>선택 전공 학과 관련 정보</h3>`;

      items.forEach(it => {
        const guideName = (it.major_ref && String(it.major_ref).trim()) ? it.major_ref : it.major;

        html += `
          <section class="detail-item">
            <ol class="info-list">
              <li><span class="k">1. 전공학과:</span> <span class="v v-major">${escapeHTML(it.major || '')}</span></li>
              <li><span class="k">2. 과목 선택안내서 표기 학과명:</span> <span class="v">${escapeHTML(guideName || '')}</span></li>
              <li>
                <span class="k">3. 학과 개요:</span>
                <div class="v desc">${escapeHTML(it.desc || '')}</div>
              </li>
            </ol>
            <br>

            <div class="section-heading"><span class="icon">📘</span><span>과목 선택</span></div>
            <ul class="info-list">
              <li><span class="k">4. 일반 선택 과목:</span> <span class="v">${escapeHTML(it.sub1 || '')}</span></li>
              <li><span class="k">5. 진로 선택 과목:</span> <span class="v">${escapeHTML(it.sub2 || '')}</span></li>
              <li><span class="k">6. 융합 선택 과목:</span> <span class="v">${escapeHTML(it.sub3 || '')}</span></li>
            </ul>
            <br>

            <div class="section-heading"><span class="icon">🎓</span><span>전공 학과 개설 대학</span></div>
            <div class="v"> :  ${escapeHTML(it.univ || '')}</div>
          </section>
        `;
      });

      html += `
        <div class="toolbar">
          <button id="backToResultsBtn">◀ 결과로 돌아가기</button>
          <button id="detailsPrintBtn"><span class="material-icons">print</span>인쇄하기</button>
        </div>`;

      area.innerHTML = html;

      document.getElementById('backToResultsBtn').onclick = () => {
        area.style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';
      };
      document.getElementById('detailsPrintBtn').onclick = () => window.print();
    }

    function backToIndex(){
      roundData = []; roundResults = []; roundHistory = [];
      autoPassList = []; hasAutoPass = false; firstRoundBye = null;
      dataIndex = new Map();
      document.getElementById('resultArea').style.display='none';
      document.getElementById('detailsArea').style.display='none';
      document.getElementById('tournament').style.display='none';
      document.getElementById('instruction').style.display='none';
      document.getElementById('inputForm').style.display='block';
    }

    /* 가로↔세로 전환 시 데스크톱에서 고정됐던 카드 높이를 모바일에서 해제 */
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 768) {
        document.querySelectorAll('.card').forEach(el => el.style.height = '');
      }
    });

    // 오른쪽 클릭 방지
    document.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</body>
</html>
