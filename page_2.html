<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전공학과 월드컵 - 과목 보기 (page_2)</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', system-ui, -apple-system, sans-serif; margin:0; background:#f9fafb; color:#111827; }
    .container { max-width: 1100px; margin: 32px auto 60px; padding: 0 20px; }
    button:active{ transform: translateY(1px); }

    .topbar { display:flex; justify-content: space-between; align-items:center; margin-bottom: 18px; }
    .topbar .title { font-size: 24px; font-weight: 800; }
    .icon-btn { border:none; background:none; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-size:18px; }
    .icon-btn .material-icons { font-size: 26px; vertical-align: middle; }

    .category { display:flex; gap:12px; flex-wrap: wrap; margin: 14px 0 22px; }
    .category button { font-size:18px; padding:12px 18px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer; }
    .category button.active { background:#111827; color:#fff; border-color:#111827; }

    .note { font-size: 14px; color:#6b7280; margin-top: 6px; }

    .loading { display:none; align-items:center; gap:10px; color:#374151; margin: 12px 0 8px; }
    .spinner { border:4px solid #e5e7eb; border-top:4px solid #6b7280; border-radius:50%; width:22px; height:22px; animation:spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; margin-top: 18px; }
    .card {
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px;
      cursor:pointer; box-shadow: 0 1px 2px rgba(0,0,0,.04);
      transition: transform .06s ease, box-shadow .06s ease, border-color .06s ease, background .06s ease;
      min-height: 64px; display:flex; align-items:center; justify-content:center; text-align:center;
      font-size: 18px; font-weight: 700; color:#111827;
    }
    .card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .card.selected { background:#eef2ff; border-color:#6366f1; box-shadow: inset 0 0 0 2px #6366f1; }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 18px; }
    .topbar .title { font-size: 24px; font-weight: 800; }
    .topbar .title .title-sub { font-size: 0.7em; font-weight: 450; }
    .btn.primary { background:#111827; color:#fff;border-color:#111827; }
    .btn {
      font-size:16px; padding:10px 16px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .results { display:none; margin-top: 24px; }
    #tableWrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table {
      width:100%; border-collapse: collapse; background:#fff; border-radius:12px; overflow: hidden;
      table-layout: fixed; min-width: 560px;
    }
    th, td { border:1px solid #e5e7eb; padding:12px 10px; text-align:left; vertical-align: top; width: 25%; }
    th { background:#f3f4f6; font-weight:800; }
    td.major { font-weight: 800; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip { background:#eef2ff; border:1px solid #c7d2fe; color:#1f2937; border-radius:999px; padding:4px 10px; font-size:14px; }

    .hidden { display:none !important; }

    .print-area { margin-top: 20px; text-align: center; }
    .print-area .btn { background:#111827; color:#fff; border-color:#111827; }

    @media (max-width: 640px) {
      .container { margin: 20px auto 36px; padding: 0 12px; }
      .topbar .title { font-size: 18px; line-height: 1.3; }
      .icon-btn { font-size: 16px; }
      .icon-btn .material-icons { font-size: 22px; }
      .category { gap:8px; }
      .category button { width:100%; font-size:16px; padding:10px 12px; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
      .card { font-size:16px; min-height:56px; padding:10px; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar .btn { width:100%; justify-content:center; }
      .results { margin-top:18px; }
      th, td { padding:10px 8px; font-size:14px; }
      .chip { font-size:12px; padding:3px 8px; }
    }

    @media (max-width: 360px) {
      .card { min-height: 50px; }
      .topbar .title { font-size: 16px; }
    }

    /* ✅ A안: 현재 페이지에서 표만 인쇄 (부모/내용 복구 + 제목 출력) */
    @media print {
      /* 기본적으로 전부 숨김 */
      body.printing-only-table * { display: none !important; }

      /* 조상/영역 복구: 렌더링 경로 보장 */
      body.printing-only-table .container,
      body.printing-only-table .results,
      body.printing-only-table #results { display:block !important; }

      /* 상단 제목(원하신 문구) 출력 */
      body.printing-only-table .topbar { display:block !important; }
      body.printing-only-table .topbar .title { display:block !important; margin-bottom:12px; }
      /* ⬇️ 이 줄을 추가: 소제목(학교명)도 인쇄에 포함 + 작은 글씨 */
      body.printing-only-table .topbar .title .title-sub { display: inline !important; font-size: 0.85em !important; color: #6b7280 !important; margin-left: 6px; }

      /* 표와 내부 구조 복구 */
      body.printing-only-table #tableWrap { display:block !important; width:100% !important; }
      body.printing-only-table #tableWrap table { display:table !important; width:100% !important; table-layout:fixed !important; }
      body.printing-only-table #tableWrap thead { display:table-header-group !important; }
      body.printing-only-table #tableWrap tbody { display:table-row-group !important; }
      body.printing-only-table #tableWrap tr { display:table-row !important; }
      body.printing-only-table #tableWrap th,
      body.printing-only-table #tableWrap td { display:table-cell !important; }

      /* ✅ 과목 칩 UI도 보이도록 복구 */
      body.printing-only-table #tableWrap .chips { display:flex !important; flex-wrap:wrap !important; gap:6px !important; }
      body.printing-only-table #tableWrap .chip { display:inline-block !important; }

      @page { size: A4; margin: 12mm; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="title">
        전공 관련 고등학교 선택 과목 보기
        <small class="title-sub">(양정고등학교 교수학습지원센터)</small>
      </div>
      <button class="icon-btn" onclick="goToIndex()">
        <span class="material-icons">home</span> 메인으로
      </button>
    </div>

    <div>
      <div class="category" id="categoryBar">
        <button id="btnInmun" onclick="startCategory('inmun')">인문+공통+체육</button>
        <button id="btnJayeon" onclick="startCategory('jayeon')">자연+공통</button>
      </div>
      <div class="note">「인문+공통+체육」또는「자연+공통」중에 관심 계열을 선택하면 <b>학과(major)</b> 목록이 표시됩니다. 여러 개의 관심 학과를 선택할 수 있으며, 아래〈고등학교 선택과목 보기〉버튼을 클릭하면 전공 관련 이수 과목을 알아 볼 수 있습니다.</div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div> <span>데이터 불러오는 중…</span></div>

    <div class="grid" id="cardGrid"></div>

    <div class="toolbar">
      <button class="btn primary" id="showSubjectsBtn" onclick="showSelectedSubjects()" disabled>
        <span class="material-icons">menu_book</span> 고등학교 선택과목 보기
      </button>
      <button class="btn" onclick="clearSelection()">
        <span class="material-icons">deselect</span> 선택 해제
      </button>
    </div>

    <div class="results" id="results">
      <h3>선택 전공의 과목 안내</h3>
      <div class="note">선택된 전공의 <b>일반선택 / 진로선택 / 융합선택</b> 과목을 확인하세요.</div>
      <div id="tableWrap"></div>

      <div class="print-area">
        <button class="btn" id="printTableBtn">
          <span class="material-icons">print</span> 표만 인쇄
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="./assets/app.js"></script>

  <script>
    let dataIndex = new Map(); // major -> item
    let selected = new Set();
    let currentCategory = null;

    function goToIndex() { location.href = './index.html'; }

    function startCategory(sheetName) {
      if (currentCategory === sheetName) return;
      currentCategory = sheetName;
      highlightCategory(sheetName);
      resetViewBeforeLoad();
      document.getElementById('loading').style.display = 'flex';

      fetchSheetRows(sheetName)
        .then(items => {
          document.getElementById('loading').style.display = 'none';
          if (!Array.isArray(items) || items.length === 0) { alert('데이터가 없습니다.'); return; }
          dataIndex = new Map();
          items.forEach(it => { if (it?.major) dataIndex.set(String(it.major), it); });
          renderCards([...dataIndex.values()]);
        })
        .catch(err => {
          document.getElementById('loading').style.display = 'none';
          console.error(err);
          alert('데이터 불러오기 실패: ' + (err?.message || err));
        });
    }

    function highlightCategory(sheetName) {
      document.getElementById('btnInmun').classList.toggle('active', sheetName === 'inmun');
      document.getElementById('btnJayeon').classList.toggle('active', sheetName === 'jayeon');
    }

    function resetViewBeforeLoad() {
      selected.clear();
      document.getElementById('cardGrid').innerHTML = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('tableWrap').innerHTML = '';
      setShowBtnDisabled(true);
    }

    function setShowBtnDisabled(state) {
      document.getElementById('showSubjectsBtn').disabled = state;
    }

    function renderCards(list) {
      const grid = document.getElementById('cardGrid');
      grid.innerHTML = '';
      list.forEach(it => {
        const major = String(it.major);
        const card = document.createElement('div');
        card.className = 'card';
        card.textContent = major;
        card.dataset.major = major;
        card.addEventListener('click', () => toggleSelect(card));
        grid.appendChild(card);
      });
    }

    function toggleSelect(cardEl) {
      const major = cardEl.dataset.major;
      if (selected.has(major)) { selected.delete(major); cardEl.classList.remove('selected'); }
      else { selected.add(major); cardEl.classList.add('selected'); }
      setShowBtnDisabled(selected.size === 0);
    }

    function clearSelection() {
      selected.clear();
      document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
      setShowBtnDisabled(true);
    }

    function showSelectedSubjects() {
      if (selected.size === 0) { alert('전공을 하나 이상 선택해주세요.'); return; }
      const majors = [...selected];
      const rows = majors.map(m => dataIndex.get(m)).filter(Boolean).map(it => ({
        major: it.major ?? '', sub1: it.sub1 ?? '', sub2: it.sub2 ?? '', sub3: it.sub3 ?? ''
      }));
      const wrap = document.getElementById('tableWrap');
      wrap.innerHTML = buildSubjectsTable(rows);
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function buildSubjectsTable(rows) {
      const toChips = (txt) => {
        const parts = String(txt).split(/[,;\/\n]+/).map(s => s.trim()).filter(Boolean);
        if (parts.length === 0) return '<span class="chip">-</span>';
        return `<div class="chips">${parts.map(p => `<span class="chip">${escapeHTML(p)}</span>`).join('')}</div>`;
      };
      let html = `<table><thead><tr>
        <th style="width:22%;">전공(major)</th>
        <th style="width:26%;">일반선택 (sub1)</th>
        <th style="width:26%;">진로선택 (sub2)</th>
        <th style="width:26%;">융합선택 (sub3)</th>
      </tr></thead><tbody>`;
      rows.forEach(r => {
        html += `<tr>
          <td class="major">${escapeHTML(r.major)}</td>
          <td>${toChips(r.sub1)}</td>
          <td>${toChips(r.sub2)}</td>
          <td>${toChips(r.sub3)}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      return html;
    }

    function escapeHTML(str) {
      return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", '&#39;');
    }

    /* ---------- A안: 현재 페이지에서 표만 인쇄 ---------- */
    function printTableOnly() {
      const wrap = document.getElementById('tableWrap');
      if (!wrap || !wrap.innerHTML.trim()) { alert('인쇄할 표가 없습니다. 먼저 전공을 선택하고 표를 생성하세요.'); return; }

      document.body.classList.add('printing-only-table');

      const after = () => {
        document.body.classList.remove('printing-only-table');
        window.removeEventListener('afterprint', after);
        window.onafterprint = null;
      };
      window.addEventListener('afterprint', after);
      window.onafterprint = after; // 일부 브라우저 호환

      // 스타일 적용이 렌더링된 다음 인쇄(PC에서 미리보기 안 뜨는 문제 방지)
      const doPrint = () => window.print();
      if (window.requestAnimationFrame) {
        requestAnimationFrame(() => requestAnimationFrame(doPrint));
      } else {
        setTimeout(doPrint, 0);
      }

      // 안전장치(혹시 afterprint가 동작 안 하면 복구)
      setTimeout(() => document.body.classList.remove('printing-only-table'), 3000);
    }

    (function attachHandlers() {
      const printBtn = document.getElementById('printTableBtn');
      if (printBtn) printBtn.addEventListener('click', printTableOnly);
    })();

    document.addEventListener('contextmenu', e => e.preventDefault(), { passive:false });
  </script>
</body>
</html>
