<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì „ê³µí•™ê³¼ ì›”ë“œì»µ - ê³¼ëª© ë³´ê¸° (page_2)</title>
  <!-- ë¨¸í‹°ë¦¬ì–¼ ì•„ì´ì½˜ (ì„ íƒì‚¬í•­: í™ˆ ì•„ì´ì½˜ ë“±) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', system-ui, -apple-system, sans-serif; margin:0; background:#f9fafb; color:#111827; }
    .container { max-width: 1100px; margin: 32px auto 60px; padding: 0 20px; }
    button:active{ transform: translateY(1px); }

    /* ìƒë‹¨ ë°” */
    .topbar { display:flex; justify-content: space-between; align-items:center; margin-bottom: 18px; }
    .topbar .title { font-size: 24px; font-weight: 800; }
    .icon-btn { border:none; background:none; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-size:18px; }
    .icon-btn .material-icons { font-size: 26px; vertical-align: middle; }

    /* ì¹´í…Œê³ ë¦¬ ì„ íƒ */
    .category { display:flex; gap:12px; flex-wrap: wrap; margin: 14px 0 22px; }
    .category button { font-size:18px; padding:12px 18px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer; }
    .category button.active { background:#111827; color:#fff; border-color:#111827; }

    /* ì•ˆë‚´/ìƒíƒœ */
    .note { font-size: 14px; color:#6b7280; margin-top: 6px; }

    /* ë¡œë”© */
    .loading { display:none; align-items:center; gap:10px; color:#374151; margin: 12px 0 8px; }
    .spinner { border:4px solid #e5e7eb; border-top:4px solid #6b7280; border-radius:50%; width:22px; height:22px; animation:spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; margin-top: 18px; }
    .card {
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px;
      cursor:pointer; box-shadow: 0 1px 2px rgba(0,0,0,.04);
      transition: transform .06s ease, box-shadow .06s ease, border-color .06s ease, background .06s ease;
      min-height: 64px; display:flex; align-items:center; justify-content:center; text-align:center;
      font-size: 18px; font-weight: 700; color:#111827;
    }
    .card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .card.selected { background:#eef2ff; border-color:#6366f1; box-shadow: inset 0 0 0 2px #6366f1; }

    /* í•˜ë‹¨ íˆ´ë°” */
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 18px; }
    .btn.primary { background:#111827; color:#fff;border-color:#111827; }
    .btn {
      font-size:16px; padding:10px 16px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    /* ê²°ê³¼ í…Œì´ë¸” */
    .results { display:none; margin-top: 24px; }
    table {
      width:100%;
      border-collapse: collapse;
      background:#fff;
      border-radius:12px;
      overflow: hidden;
      table-layout: fixed;   /* ğŸ‘ˆ ê³ ì • ë ˆì´ì•„ì›ƒ */
    }
    th, td {
      border:1px solid #e5e7eb;
      padding:12px 10px;
      text-align:left;
      vertical-align: top;
      width: 25%;            /* ğŸ‘ˆ ì „ì²´ 4ì—´ â†’ 25%ì”© */
    }
    th { background:#f3f4f6; font-weight:800; }
    td.major { font-weight: 800; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip {
      background:#eef2ff; border:1px solid #c7d2fe; color:#1f2937;
      border-radius:999px; padding:4px 10px; font-size:14px;
    }

    /* ìˆ¨ê¹€/í‘œì‹œ í† ê¸€ */
    .hidden { display:none !important; }

    .print-area {
      margin-top: 20px;
      text-align: center;   /* ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ */
    }
    .print-area .btn {
      background:#111827;   /* í•„ìš”ì‹œ primary ìŠ¤íƒ€ì¼ */
      color:#fff;
      border-color:#111827;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ìƒë‹¨ ë°” -->
    <div class="topbar">
      <div class="title">ì „ê³µ ê´€ë ¨ ê³ ë“±í•™êµ ì„ íƒ ê³¼ëª© ë³´ê¸°</div>
      <button class="icon-btn" onclick="goToIndex()">
        <span class="material-icons">home</span> ë©”ì¸ìœ¼ë¡œ
      </button>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
    <div>
      <div class="category" id="categoryBar">
        <button id="btnInmun" onclick="startCategory('inmun')">ì¸ë¬¸+ê³µí†µ+ì²´ìœ¡</button>
        <button id="btnJayeon" onclick="startCategory('jayeon')">ìì—°+ê³µí†µ</button>
      </div>
      <div class="note">ã€Œì¸ë¬¸+ê³µí†µ+ì²´ìœ¡ã€ë˜ëŠ”ã€Œìì—°+ê³µí†µã€ì¤‘ì— ê´€ì‹¬ ê³„ì—´ì„ ì„ íƒí•˜ë©´ <b>í•™ê³¼(major)</b> ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤. ì—¬ëŸ¬ ê°œì˜ ê´€ì‹¬ í•™ê³¼ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìœ¼ë©°, ì•„ë˜ã€ˆê³ ë“±í•™êµ ì„ íƒê³¼ëª© ë³´ê¸°ã€‰ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì „ê³µ ê´€ë ¨ ì´ìˆ˜ ê³¼ëª©ì„ ì•Œì•„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- ë¡œë”© -->
    <div class="loading" id="loading"><div class="spinner"></div> <span>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span></div>

    <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div class="grid" id="cardGrid"></div>

    <!-- í•˜ë‹¨ íˆ´ë°” -->
    <div class="toolbar">
      <button class="btn primary" id="showSubjectsBtn" onclick="showSelectedSubjects()" disabled>
        <span class="material-icons">menu_book</span> ê³ ë“±í•™êµ ì„ íƒê³¼ëª© ë³´ê¸°
      </button>
      <button class="btn" onclick="clearSelection()">
        <span class="material-icons">deselect</span> ì„ íƒ í•´ì œ
      </button>
    </div>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <div class="results" id="results">
      <h3>ì„ íƒ ì „ê³µì˜ ê³¼ëª© ì•ˆë‚´</h3>
      <div class="note">ì„ íƒëœ ì „ê³µì˜ <b>ì¼ë°˜ì„ íƒ / ì§„ë¡œì„ íƒ / ìœµí•©ì„ íƒ</b> ê³¼ëª©ì„ í™•ì¸í•˜ì„¸ìš”.</div>
      <div id="tableWrap"></div>

      <!-- ğŸ‘‡ ì¸ì‡„ ë²„íŠ¼ì„ ê²°ê³¼ í…Œì´ë¸” ë’¤ì— ì¤‘ì•™ ì •ë ¬ë¡œ ì¶”ê°€ -->
      <div class="print-area">
        <!-- ê²°ê³¼ í…Œì´ë¸”ë§Œ ì¸ì‡„ -->
        <button class="btn" id="printTableBtn">
          <span class="material-icons">print</span> í‘œë§Œ ì¸ì‡„
        </button>
      </div>
    </div>
  </div> <!-- âœ… ëˆ„ë½ë˜ë˜ container ë‹«ê¸° -->

  <script>
    // ë°ì´í„° ë³´ê´€
    let dataIndex = new Map(); // major -> item
    let selected = new Set();  // ì„ íƒëœ major
    let currentCategory = null;

    // í™ˆ(ë©”ì¸)ìœ¼ë¡œ
    function goToIndex() {
      google.script.run.withSuccessHandler(function(html){
        document.open(); document.write(html); document.close();
      }).getIndex();
    }

    // ì¹´í…Œê³ ë¦¬ ì‹œì‘ (ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ)
    function startCategory(sheetName) {
      if (currentCategory === sheetName) return; // ê°™ì€ ì¹´í…Œê³ ë¦¬ ì¬í´ë¦­ ë°©ì§€
      currentCategory = sheetName;
      highlightCategory(sheetName);
      resetViewBeforeLoad();

      document.getElementById('loading').style.display = 'flex';
      google.script.run
        .withSuccessHandler(items => {
          document.getElementById('loading').style.display = 'none';
          if (!Array.isArray(items) || items.length === 0) {
            alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          // ì¸ë±ìŠ¤ êµ¬ì„± (major -> item)
          dataIndex = new Map();
          items.forEach(it => { if (it?.major) dataIndex.set(String(it.major), it); });

          renderCards([...dataIndex.values()]);
        })
        .withFailureHandler(err => {
          document.getElementById('loading').style.display = 'none';
          console.error(err);
          alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (err?.message || err));
        })
        .getMajors(sheetName);
    }

    function highlightCategory(sheetName) {
      document.getElementById('btnInmun').classList.toggle('active', sheetName === 'inmun');
      document.getElementById('btnJayeon').classList.toggle('active', sheetName === 'jayeon');
    }

    function resetViewBeforeLoad() {
      // ì¹´ë“œ/ì„ íƒ/ê²°ê³¼ ì´ˆê¸°í™”
      selected.clear();
      document.getElementById('cardGrid').innerHTML = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('tableWrap').innerHTML = '';
      setShowBtnDisabled(true);
    }

    function setShowBtnDisabled(state) {
      document.getElementById('showSubjectsBtn').disabled = state;
    }

    // ì¹´ë“œ ë Œë”
    function renderCards(list) {
      const grid = document.getElementById('cardGrid');
      grid.innerHTML = '';
      list.forEach(it => {
        const major = String(it.major);
        const card = document.createElement('div');
        card.className = 'card';
        card.textContent = major;
        card.dataset.major = major;
        card.addEventListener('click', () => toggleSelect(card));
        grid.appendChild(card);
      });
    }

    // ì„ íƒ í† ê¸€
    function toggleSelect(cardEl) {
      const major = cardEl.dataset.major;
      if (selected.has(major)) {
        selected.delete(major);
        cardEl.classList.remove('selected');
      } else {
        selected.add(major);
        cardEl.classList.add('selected');
      }
      setShowBtnDisabled(selected.size === 0);
    }

    // ì„ íƒ í•´ì œ
    function clearSelection() {
      selected.clear();
      document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
      setShowBtnDisabled(true);
    }

    // ì„ íƒëœ ì „ê³µì˜ ê³¼ëª© ë³´ê¸°
    function showSelectedSubjects() {
      if (selected.size === 0) {
        alert('ì „ê³µì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      const majors = [...selected];
      const rows = majors
        .map(m => dataIndex.get(m))
        .filter(Boolean)
        .map(it => ({
          major: it.major ?? '',
          sub1: it.sub1 ?? '',
          sub2: it.sub2 ?? '',
          sub3: it.sub3 ?? ''
        }));

      const tableHTML = buildSubjectsTable(rows);
      const wrap = document.getElementById('tableWrap');
      wrap.innerHTML = tableHTML;
      document.getElementById('results').style.display = 'block';
      // ìŠ¤í¬ë¡¤ ì´ë™(ì„ íƒ)
      document.getElementById('results').scrollIntoView({ behavior:'smooth', block:'start' });
    }

    // ê³¼ëª© í…Œì´ë¸” ë§Œë“¤ê¸°
    function buildSubjectsTable(rows) {
      // ê³¼ëª© ë¬¸ìì—´ì„ ì¹©ìœ¼ë¡œ ì˜ˆì˜ê²Œ í‘œí˜„
      const toChips = (txt) => {
        const parts = String(txt).split(/[,;\/\n]+/).map(s => s.trim()).filter(Boolean);
        if (parts.length === 0) return '<span class="chip">-</span>';
        return `<div class="chips">${parts.map(p => `<span class="chip">${escapeHTML(p)}</span>`).join('')}</div>`;
      };

      let html = `<table>
        <thead>
          <tr>
            <th style="width:22%;">ì „ê³µ(major)</th>
            <th style="width:26%;">ì¼ë°˜ì„ íƒ (sub1)</th>
            <th style="width:26%;">ì§„ë¡œì„ íƒ (sub2)</th>
            <th style="width:26%;">ìœµí•©ì„ íƒ (sub3)</th>
          </tr>
        </thead>
        <tbody>`;

      rows.forEach(r => {
        html += `<tr>
          <td class="major">${escapeHTML(r.major)}</td>
          <td>${toChips(r.sub1)}</td>
          <td>${toChips(r.sub2)}</td>
          <td>${toChips(r.sub3)}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      return html;
    }

    // ì•ˆì „ ì¶œë ¥
    function escapeHTML(str) {
      return String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'", '&#39;');
    }

    /* ---------- (A) ê²°ê³¼ í…Œì´ë¸”ë§Œ ì¸ì‡„ ---------- */
    function printTableOnly() {
      const src = document.getElementById('tableWrap');
      if (!src || !src.innerHTML.trim()) {
        alert('ì¸ì‡„í•  í‘œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì „ê³µì„ ì„ íƒí•˜ê³  í‘œë¥¼ ìƒì„±í•˜ì„¸ìš”.');
        return;
      }
      const win = window.open('', '_blank');
      // ê¸°ë³¸ í…Œì´ë¸”/ì¹© ìŠ¤íƒ€ì¼ë§Œ ìµœì†Œ í¬í•¨
      win.document.write(`
        <html>
          <head>
            <meta charset="UTF-8" />
            <title>í‘œë§Œ ì¸ì‡„</title>
            <style>
              body { font-family: 'Noto Sans KR', system-ui, -apple-system, sans-serif; margin:20px; }
              table { width:100%; border-collapse: collapse; table-layout: fixed; page-break-inside: auto; }
              thead { display: table-header-group; }
              tfoot { display: table-footer-group; }
              tr { page-break-inside: avoid; page-break-after: auto; } /* âœ… ë‹«ëŠ” ì¤‘ê´„í˜¸ ì¶”ê°€ */
              th, td { border:1px solid #e5e7eb; padding:12px 10px; text-align:left; vertical-align: top; }
              th { background:#f3f4f6; font-weight:800; }
              td.major { font-weight:800; }
              .chips { display:flex; flex-wrap:wrap; gap:6px; }
              .chip { background:#eef2ff; border:1px solid #c7d2fe; color:#1f2937; border-radius:999px; padding:4px 10px; font-size:14px; }
              @page { size: A4; margin: 12mm; }
            </style>
          </head>
          <body>${src.innerHTML}</body>
        </html>
      `);
      win.document.close();
      // ìƒˆ ì°½ ë¡œë”© ì™„ë£Œ í›„ ì¸ì‡„
      win.focus();
      win.onload = () => { win.print(); win.close(); };
    }

    /* ---------- (C) ë²„íŠ¼ ì—°ê²° ---------- */
    (function attachHandlers() {
      const printBtn = document.getElementById('printTableBtn');
      const pdfBtn   = document.getElementById('savePdfTableBtn'); // (ì˜µì…˜) ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ë¬´ì‹œë¨

      if (printBtn) {
        printBtn.addEventListener('click', printTableOnly);
      }
      if (pdfBtn) {
        pdfBtn.addEventListener('click', () => downloadElementAsPDF('tableWrap', 'ì„ íƒê³¼ëª©_ë³´ê¸°.pdf'));
      }
    })();

    // ìš°í´ë¦­ ë°©ì§€(ì„ íƒ)
    document.addEventListener('contextmenu', e => e.preventDefault(), { passive:false });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="./assets/app.js"></script>
</body>
</html>

